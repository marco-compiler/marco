#include "marco/Modeling/IndexSet.h"
#include "gmock/gmock.h"
#include "gtest/gtest.h"

using namespace ::marco::modeling;

TEST(IndexSet, empty) {
  IndexSet emptyIndexSet;
  EXPECT_TRUE(emptyIndexSet.empty());

  IndexSet nonEmptyIndexSet(MultidimensionalRange({Range(2, 5), Range(3, 7)}));

  EXPECT_FALSE(nonEmptyIndexSet.empty());
}

TEST(IndexSet, size) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(1, 5), Range(3, 7)});
  indices += MultidimensionalRange({Range(3, 8), Range(2, 5)});

  EXPECT_EQ(indices.size(), 27);
}

TEST(IndexSet, clear) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(1, 5), Range(3, 7)});

  indices.clear();
  EXPECT_EQ(indices.size(), 0);
}

TEST(IndexSet, containsElement) {
  MultidimensionalRange range1({Range(1, 3), Range(4, 7)});
  MultidimensionalRange range2({Range(5, 9), Range(1, 3)});

  IndexSet indices({range1, range2});

  EXPECT_TRUE(indices.contains(Point({2, 5})));
  EXPECT_TRUE(indices.contains(Point({5, 1})));
  EXPECT_FALSE(indices.contains(Point({2, 7})));
}

TEST(IndexSet, containsRange) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(1, 3), Range(4, 7)});
  indices += MultidimensionalRange({Range(1, 3), Range(7, 9)});
  indices += MultidimensionalRange({Range(5, 9), Range(1, 3)});

  EXPECT_TRUE(
      indices.contains(MultidimensionalRange({Range(2, 3), Range(5, 6)})));

  EXPECT_TRUE(
      indices.contains(MultidimensionalRange({Range(2, 3), Range(5, 8)})));

  EXPECT_TRUE(
      indices.contains(MultidimensionalRange({Range(5, 7), Range(1, 3)})));

  EXPECT_FALSE(
      indices.contains(MultidimensionalRange({Range(5, 6), Range(5, 7)})));
}

TEST(IndexSet, overlapsRange) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(1, 3), Range(4, 7)});
  indices += MultidimensionalRange({Range(1, 3), Range(7, 9)});
  indices += MultidimensionalRange({Range(5, 9), Range(1, 3)});

  EXPECT_TRUE(
      indices.overlaps(MultidimensionalRange({Range(2, 4), Range(1, 5)})));

  EXPECT_TRUE(
      indices.overlaps(MultidimensionalRange({Range(3, 7), Range(2, 4)})));

  EXPECT_TRUE(
      indices.overlaps(MultidimensionalRange({Range(1, 6), Range(1, 5)})));
}

TEST(IndexSet, addRange) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(1, 3), Range(4, 7)});
  EXPECT_FALSE(indices.contains(Point({2, 3})));

  indices += MultidimensionalRange({Range(1, 3), Range(2, 4)});
  EXPECT_TRUE(indices.contains(Point({2, 3})));
}

TEST(IndexSet, addOverlappingRange) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(1, 3), Range(4, 7)});
  indices += MultidimensionalRange({Range(1, 9), Range(7, 10)});
  indices += MultidimensionalRange({Range(7, 9), Range(4, 8)});
  indices += MultidimensionalRange({Range(2, 8), Range(4, 9)});

  EXPECT_TRUE(
      indices.contains(MultidimensionalRange({Range(1, 9), Range(4, 10)})));
}

TEST(IndexSet, addMultipleRanges) {
  IndexSet indices;

  indices += MultidimensionalRange({Range(3, 5), Range(7, 9)});
  indices += MultidimensionalRange({Range(3, 5), Range(9, 11)});
  indices += MultidimensionalRange({Range(5, 8), Range(7, 8)});
  indices += MultidimensionalRange({Range(5, 8), Range(8, 11)});

  EXPECT_TRUE(
      indices.contains(MultidimensionalRange({Range(3, 8), Range(7, 11)})));
}

TEST(IndexSet, removeRange) {
  MultidimensionalRange range({Range(2, 5), Range(3, 7)});
  IndexSet indices(range);
  MultidimensionalRange removed({Range(3, 9), Range(1, 4)});
  indices -= removed;

  for (Point point : range) {
    EXPECT_EQ(indices.contains(point), !removed.contains(point));
  }
}

TEST(IndexSet, complement) {
  llvm::SmallVector<MultidimensionalRange, 3> ranges;
  ranges.push_back(MultidimensionalRange({Range(1, 5), Range(3, 7)}));
  ranges.push_back(MultidimensionalRange({Range(3, 8), Range(2, 5)}));
  IndexSet original;

  for (const auto &range : ranges) {
    original += range;
  }

  MultidimensionalRange range({Range(2, 7), Range(0, 6)});

  IndexSet result = original.complement(range);

  for (auto indexes : ranges[0])
    EXPECT_FALSE(result.contains(indexes));

  for (auto indexes : ranges[1])
    EXPECT_FALSE(result.contains(indexes));

  for (auto indexes : range) {
    EXPECT_EQ(result.contains(indexes),
              std::none_of(ranges.begin(), ranges.end(),
                           [&](const MultidimensionalRange &r) {
                             return r.contains(indexes);
                           }));
  }
}

TEST(IndexSet, complementEmptyBase) {
  IndexSet original;

  MultidimensionalRange range({Range(2, 7), Range(0, 6)});

  IndexSet result = original.complement(range);

  for (auto indexes : range)
    EXPECT_TRUE(result.contains(indexes));
}

TEST(IndexSet, rangesIteration) {
  MultidimensionalRange a({Range(1, 3), Range(2, 5), Range(8, 10)});

  IndexSet set(a);

  size_t count = 0;
  for (auto range : llvm::make_range(set.rangesBegin(), set.rangesEnd())) {
    EXPECT_EQ(range, a);
    ++count;
  }

  EXPECT_EQ(count, 1);
}

TEST(IndexSet, indexesIteration) {
  IndexSet range(
      MultidimensionalRange({Range(1, 3), Range(2, 5), Range(8, 10)}));

  llvm::SmallVector<std::tuple<long, long, long>, 3> expected;
  expected.emplace_back(1, 2, 8);
  expected.emplace_back(1, 2, 9);
  expected.emplace_back(1, 3, 8);
  expected.emplace_back(1, 3, 9);
  expected.emplace_back(1, 4, 8);
  expected.emplace_back(1, 4, 9);
  expected.emplace_back(2, 2, 8);
  expected.emplace_back(2, 2, 9);
  expected.emplace_back(2, 3, 8);
  expected.emplace_back(2, 3, 9);
  expected.emplace_back(2, 4, 8);
  expected.emplace_back(2, 4, 9);

  size_t index = 0;

  for (auto it = range.begin(), end = range.end(); it != end; ++it) {
    auto values = *it;

    EXPECT_EQ(values.rank(), 3);
    EXPECT_EQ(values[0], std::get<0>(expected[index]));
    EXPECT_EQ(values[1], std::get<1>(expected[index]));
    EXPECT_EQ(values[2], std::get<2>(expected[index]));

    ++index;
  }
}

TEST(IndexSet, randomInsertionAndRemovalOfRanges) {
  IndexSet indices;

  llvm::SmallVector<int64_t> insertedRangesBoundaries(
      {4963, 4969, 771,  774,  2541, 2548, 1320, 1330,  2055, 2058, 2231, 2236,
       1728, 1737, 1236, 1246, 908,  914,  3822, 3827,  8648, 8654, 7274, 7284,
       9416, 9426, 1629, 1630, 4941, 4950, 1861, 1862,  941,  943,  7310, 7319,
       9858, 9860, 3099, 3107, 345,  354,  3650, 3654,  7995, 8000, 1837, 1838,
       5482, 5487, 5636, 5641, 2364, 2367, 9116, 9125,  6117, 6127, 949,  957,
       6210, 6212, 5985, 5991, 1594, 1603, 8920, 8930,  500,  504,  2599, 2607,
       1891, 1892, 9476, 9478, 6849, 6854, 1207, 1208,  7753, 7754, 4095, 4097,
       1246, 1251, 2884, 2890, 4902, 4911, 8323, 8326,  8700, 8709, 4173, 4176,
       621,  627,  6273, 6279, 8386, 8390, 3474, 3482,  1419, 1429, 1990, 2000,
       2431, 2435, 4245, 4255, 3632, 3639, 7328, 7337,  1531, 1532, 9299, 9304,
       1691, 1701, 385,  394,  6362, 6370, 5456, 5463,  6378, 6385, 4072, 4076,
       5479, 5482, 4758, 4767, 7990, 7991, 7425, 7432,  3981, 3987, 9711, 9716,
       5833, 5842, 5634, 5644, 7516, 7519, 9080, 9082,  2558, 2565, 9750, 9760,
       8489, 8495, 2508, 2513, 3028, 3033, 3353, 3361,  5796, 5799, 9895, 9902,
       8684, 8685, 9907, 9917, 9110, 9117, 8244, 8252,  8959, 8960, 8041, 8045,
       3892, 3896, 672,  681,  9751, 9757, 1508, 1512,  8602, 8612, 5729, 5735,
       3887, 3893, 5074, 5078, 9928, 9931, 4081, 4091,  3247, 3252, 4067, 4069,
       9830, 9837, 178,  181,  8539, 8548, 1651, 1655,  8297, 8299, 7856, 7858,
       7171, 7172, 8621, 8624, 7243, 7245, 53,   63,    6805, 6808, 8234, 8240,
       9411, 9415, 3320, 3324, 1848, 1858, 116,  126,   3591, 3599, 6602, 6611,
       8281, 8284, 3896, 3901, 5103, 5111, 1361, 1367,  416,  419,  7385, 7388,
       1957, 1962, 4596, 4606, 1278, 1288, 601,  603,   8136, 8139, 150,  160,
       7857, 7859, 9859, 9868, 9934, 9941, 821,  827,   5486, 5488, 3574, 3576,
       145,  151,  2437, 2440, 7940, 7945, 3529, 3539,  3827, 3833, 1972, 1977,
       123,  129,  581,  584,  177,  179,  8029, 8038,  7984, 7988, 7755, 7757,
       8272, 8280, 996,  1004, 8308, 8314, 9264, 9270,  5788, 5791, 2413, 2415,
       6066, 6075, 3806, 3810, 5623, 5627, 2264, 2272,  5677, 5686, 7799, 7806,
       471,  481,  655,  664,  6072, 6073, 5844, 5854,  3738, 3739, 3327, 3329,
       912,  915,  9650, 9651, 3404, 3407, 3189, 3193,  9926, 9934, 2374, 2382,
       7466, 7474, 1933, 1939, 45,   51,   5558, 5562,  7618, 7627, 460,  470,
       1358, 1362, 9034, 9040, 1094, 1099, 2591, 2600,  3646, 3648, 4354, 4355,
       9165, 9173, 4645, 4650, 1441, 1448, 5827, 5835,  6879, 6880, 3685, 3693,
       8373, 8381, 7132, 7141, 9813, 9823, 3284, 3292,  4466, 4475, 222,  228,
       4810, 4812, 9346, 9353, 4342, 4350, 2583, 2587,  5442, 5447, 1749, 1752,
       9017, 9022, 317,  326,  1258, 1261, 5475, 5477,  2010, 2018, 9024, 9025,
       6737, 6739, 9107, 9116, 226,  227,  7321, 7324,  2116, 2122, 508,  516,
       2070, 2076, 9756, 9759, 2598, 2600, 147,  154,   6719, 6728, 785,  790,
       4515, 4521, 4010, 4012, 4233, 4237, 1809, 1812,  8228, 8231, 5819, 5822,
       5961, 5971, 444,  445,  1863, 1865, 6323, 6324,  1815, 1821, 5288, 5297,
       7594, 7604, 8650, 8653, 9294, 9298, 7488, 7496,  4452, 4458, 689,  690,
       8726, 8734, 5198, 5201, 4205, 4208, 8275, 8283,  6180, 6189, 7677, 7683,
       8753, 8762, 4881, 4888, 2461, 2467, 7564, 7572,  8514, 8515, 391,  401,
       1117, 1127, 3048, 3052, 4517, 4519, 3383, 3386,  4882, 4888, 927,  928,
       782,  790,  6605, 6614, 7701, 7706, 5260, 5263,  896,  902,  5047, 5050,
       5273, 5278, 8613, 8618, 7160, 7169, 3426, 3428,  9396, 9397, 3304, 3305,
       5582, 5591, 3862, 3867, 8439, 8446, 8378, 8388,  1750, 1759, 5199, 5208,
       5821, 5822, 6636, 6641, 7927, 7929, 7263, 7265,  8935, 8941, 9993, 9997,
       3379, 3387, 7628, 7638, 4519, 4521, 6093, 6098,  9211, 9215, 8748, 8751,
       6698, 6701, 9060, 9069, 7815, 7819, 2272, 2274,  5065, 5071, 2567, 2576,
       2397, 2405, 9309, 9316, 8456, 8462, 5249, 5255,  2071, 2072, 4071, 4079,
       5705, 5715, 707,  712,  8605, 8606, 2776, 2777,  3229, 3236, 1036, 1046,
       7544, 7547, 5671, 5681, 8973, 8975, 9004, 9008,  7750, 7760, 3163, 3167,
       9974, 9984, 5344, 5346, 9145, 9154, 2117, 2120,  2814, 2824, 1869, 1879,
       3598, 3603, 5521, 5530, 8105, 8113, 1424, 1434,  8898, 8905, 547,  551,
       9056, 9061, 6156, 6162, 9956, 9962, 2556, 2560,  1936, 1940, 7510, 7511,
       9502, 9511, 4152, 4159, 1508, 1518, 1327, 1330,  5326, 5328, 7861, 7866,
       4579, 4587, 4077, 4087, 8519, 8524, 1911, 1913,  1367, 1370, 7171, 7181,
       9417, 9420, 8381, 8389, 1582, 1587, 4867, 4877,  1779, 1788, 8823, 8830,
       792,  801,  6241, 6244, 2691, 2699, 4161, 4168,  903,  913,  3636, 3640,
       9400, 9409, 2807, 2814, 8236, 8238, 2373, 2377,  7966, 7967, 1332, 1334,
       6579, 6588, 4440, 4450, 4211, 4218, 2082, 2087,  4015, 4020, 930,  937,
       6833, 6842, 7554, 7564, 1173, 1179, 3423, 3427,  3206, 3211, 1011, 1019,
       4469, 4474, 5390, 5400, 1396, 1400, 5417, 5419,  2780, 2785, 4689, 4698,
       5965, 5969, 2371, 2376, 2088, 2098, 9579, 9589,  831,  833,  2564, 2567,
       1179, 1189, 821,  827,  4040, 4049, 9739, 9748,  6497, 6504, 6979, 6980,
       7292, 7296, 5682, 5689, 4236, 4245, 9168, 9169,  6235, 6241, 9830, 9836,
       7882, 7883, 9663, 9668, 3705, 3708, 3986, 3987,  1903, 1907, 9846, 9853,
       1610, 1615, 4150, 4158, 5814, 5823, 6687, 6688,  9851, 9859, 2423, 2432,
       8932, 8936, 5358, 5359, 2402, 2412, 151,  155,   7890, 7900, 9888, 9895,
       4488, 4495, 4223, 4233, 3873, 3878, 2935, 2945,  5485, 5489, 3351, 3359,
       8937, 8945, 9927, 9929, 9938, 9944, 5041, 5051,  3522, 3527, 7937, 7940,
       2173, 2179, 5492, 5502, 5815, 5823, 7804, 7806,  8437, 8444, 2193, 2197,
       7935, 7944, 5254, 5263, 2778, 2788, 144,  152,   2421, 2431, 7435, 7439,
       6437, 6441, 8877, 8878, 4741, 4745, 6348, 6357,  4812, 4815, 7890, 7894,
       3763, 3767, 7293, 7300, 787,  793,  1618, 1627,  6954, 6958, 3696, 3702,
       7537, 7543, 8617, 8620, 6049, 6050, 9324, 9333,  5877, 5881, 7636, 7646,
       3111, 3112, 8676, 8679, 2234, 2239, 3526, 3536,  1868, 1873, 2937, 2938,
       2552, 2561, 3663, 3667, 8256, 8263, 2445, 2453,  4563, 4568, 2814, 2816,
       7120, 7130, 9429, 9432, 8610, 8619, 5622, 5630,  361,  368,  6793, 6799,
       489,  492,  3834, 3837, 2673, 2678, 1181, 1184,  4110, 4119, 6475, 6479,
       3211, 3213, 9673, 9677, 4451, 4452, 9694, 9700,  1212, 1213, 1258, 1263,
       2392, 2402, 5186, 5196, 1516, 1525, 9409, 9414,  4207, 4211, 5888, 5895,
       6976, 6980, 2209, 2213, 7008, 7017, 592,  602,   2433, 2441, 7105, 7115,
       8126, 8134, 6198, 6201, 3996, 4000, 8702, 8705,  5820, 5822, 443,  447,
       2204, 2208, 3610, 3619, 7628, 7631, 5528, 5529,  5366, 5372, 92,   98,
       3384, 3385, 1597, 1598, 6339, 6346, 9340, 9350,  810,  814,  4041, 4042,
       8592, 8594, 4666, 4675, 7872, 7877, 3280, 3289,  6508, 6509, 651,  657,
       6422, 6430, 5880, 5885, 2170, 2177, 4260, 4266,  4448, 4449, 460,  465,
       680,  687,  6075, 6084, 1504, 1506, 23,   29,    5015, 5021, 8289, 8295,
       75,   76,   2081, 2087, 204,  206,  2252, 2256,  402,  404,  8604, 8612,
       2972, 2973, 7009, 7019, 3497, 3501, 1231, 1237,  3798, 3802, 9753, 9760,
       5080, 5086, 4343, 4345, 6577, 6581, 2829, 2836,  6339, 6349, 7809, 7818,
       597,  603,  1296, 1303, 4676, 4682, 1887, 1896,  9093, 9101, 1568, 1577,
       1556, 1558, 1576, 1585, 1449, 1454, 3689, 3691,  3106, 3108, 1004, 1010,
       5089, 5090, 1534, 1538, 3204, 3211, 6279, 6280,  259,  269,  5595, 5600,
       6605, 6610, 6648, 6654, 9153, 9159, 8410, 8415,  2078, 2087, 2473, 2480,
       2857, 2867, 1123, 1124, 37,   46,   1890, 1896,  1582, 1592, 8633, 8643,
       2379, 2384, 4093, 4094, 1906, 1907, 636,  640,   2134, 2143, 6855, 6862,
       2549, 2551, 2990, 2993, 1098, 1101, 295,  300,   4554, 4562, 4925, 4932,
       5649, 5656, 3519, 3522, 755,  757,  9993, 10002, 5405, 5415, 9310, 9314,
       180,  185,  8387, 8396, 5326, 5335, 9859, 9869,  5058, 5065, 1178, 1180,
       1965, 1972, 8762, 8768, 3543, 3547, 7860, 7868,  8714, 8716, 3154, 3161,
       1311, 1320, 2798, 2801, 3502, 3505, 3870, 3871,  6335, 6344, 198,  202,
       6976, 6983, 8694, 8704, 3753, 3756, 8191, 8201,  3469, 3477, 2746, 2752,
       6403, 6410, 7116, 7121, 1560, 1563, 8454, 8455,  1355, 1358, 1461, 1467,
       3937, 3945, 2152, 2159, 1315, 1323, 8061, 8063,  7958, 7965, 8030, 8033,
       3939, 3948, 2031, 2041, 7325, 7330, 7955, 7959,  6162, 6165, 6606, 6608,
       2451, 2458, 7181, 7188, 2778, 2781, 214,  216,   1945, 1955, 9333, 9339,
       2645, 2654, 1814, 1815, 4634, 4635, 6224, 6225,  6060, 6061, 4938, 4948,
       4565, 4572, 6460, 6468, 7902, 7910, 4890, 4896,  1262, 1269, 1537, 1540,
       9240, 9249, 1538, 1545, 7741, 7748, 8940, 8941,  8026, 8027, 3312, 3319,
       487,  497,  4500, 4507, 4829, 4831, 2569, 2576,  7408, 7411, 5351, 5358,
       9188, 9193, 5434, 5443, 7296, 7297, 1751, 1760,  3622, 3632, 9386, 9389,
       2727, 2731, 6081, 6088, 3992, 3995, 7598, 7599,  8831, 8835, 8717, 8727,
       6154, 6158, 9369, 9377, 6145, 6154, 9841, 9847,  2332, 2341, 2253, 2256,
       565,  572,  1406, 1408, 3452, 3460, 9445, 9453,  4679, 4682, 1783, 1785,
       3362, 3370, 4901, 4910, 3492, 3501, 4234, 4236,  2944, 2950, 6733, 6739,
       3387, 3394, 9100, 9109, 1546, 1547, 4774, 4784,  7473, 7482, 5864, 5867,
       5276, 5279, 9062, 9071, 9820, 9822, 3340, 3345,  1214, 1224, 3913, 3915,
       2213, 2214, 5132, 5136, 7187, 7196, 4137, 4147,  5993, 5997, 5434, 5440,
       6796, 6800, 2848, 2851, 516,  524,  3859, 3865,  6813, 6820, 9858, 9861,
       5846, 5856, 9601, 9609, 9271, 9278, 4633, 4642,  6645, 6647, 3080, 3087,
       3942, 3943, 8532, 8535, 3908, 3918, 8615, 8619,  4398, 4405, 4570, 4579,
       5956, 5966, 8811, 8813, 6087, 6096, 1370, 1376,  1206, 1213, 432,  436,
       2453, 2456, 4758, 4760, 8809, 8814, 5323, 5325,  3209, 3210, 8327, 8330,
       7573, 7577, 2768, 2774, 6242, 6248, 4760, 4761,  9391, 9399, 8586, 8592,
       4748, 4756, 1108, 1117, 8139, 8149, 8134, 8138,  3250, 3251, 3623, 3630,
       1977, 1980, 1313, 1322, 1824, 1826, 7866, 7870,  1705, 1713, 339,  345,
       9174, 9181, 1572, 1576, 9134, 9143, 2530, 2540,  4562, 4567, 4212, 4221,
       3974, 3984, 2769, 2773, 3526, 3536, 2820, 2824,  5811, 5815, 8329, 8338,
       3962, 3968, 6008, 6011, 2809, 2815, 5337, 5343,  6071, 6076, 7038, 7045,
       7674, 7684, 1688, 1694, 4315, 4318, 8486, 8493,  5339, 5346, 422,  427,
       1579, 1589, 7898, 7907, 3454, 3458, 3542, 3547,  7195, 7203, 8553, 8555,
       8330, 8334, 7494, 7500, 8778, 8781, 1328, 1338,  8538, 8545, 8886, 8892,
       755,  756,  9271, 9279, 1195, 1199, 8309, 8313,  2544, 2545, 6807, 6813,
       9736, 9741, 5195, 5198, 8219, 8229, 1011, 1013,  5932, 5935, 8241, 8247,
       3607, 3609, 2811, 2812, 1412, 1420, 2912, 2919,  8035, 8040, 7665, 7667,
       1015, 1023, 3958, 3961, 9062, 9063, 4541, 4548,  4677, 4684, 9964, 9971,
       6934, 6936, 4346, 4355, 6492, 6496, 6269, 6279,  5029, 5037, 6439, 6449,
       7034, 7040, 2622, 2627, 837,  846,  1375, 1384,  9369, 9370, 225,  226,
       3304, 3310, 7090, 7091, 1062, 1067, 2501, 2511,  1521, 1523, 7627, 7633,
       3848, 3853, 2756, 2765, 711,  715,  8426, 8433,  3785, 3787, 3548, 3551,
       9183, 9187, 8944, 8947, 2151, 2161, 8804, 8812,  3413, 3422, 1448, 1449,
       5684, 5687, 6961, 6962, 9902, 9910, 6586, 6588,  9354, 9356, 3914, 3919,
       3964, 3965, 1276, 1283, 5610, 5618, 3355, 3357,  855,  864,  140,  141,
       268,  274,  4554, 4555, 9642, 9651, 9959, 9967,  9477, 9483, 1188, 1189,
       9320, 9321, 4794, 4796, 6093, 6102, 7487, 7494,  6670, 6675, 5928, 5935,
       9966, 9970, 9799, 9804, 2200, 2201, 6940, 6943,  854,  856,  8703, 8708,
       8912, 8917, 5409, 5418, 9410, 9415, 3637, 3639,  281,  285,  2658, 2661,
       5854, 5864, 6716, 6720, 1014, 1024, 9653, 9662,  8443, 8451, 5285, 5287,
       7004, 7005, 756,  760,  5538, 5546, 1271, 1276,  4702, 4703, 3571, 3580,
       5454, 5461, 8742, 8751, 8463, 8472, 1603, 1606,  5779, 5786, 8454, 8455,
       7927, 7931, 9959, 9969, 6306, 6307, 2388, 2391,  7098, 7106, 7435, 7442,
       7454, 7458, 7295, 7303, 6420, 6421, 6547, 6551,  2263, 2266, 5754, 5755,
       5467, 5474, 3751, 3753, 8835, 8843, 270,  271,   6546, 6549, 8366, 8375,
       7380, 7388, 7007, 7016, 4865, 4874, 7195, 7201,  7197, 7206, 3101, 3107,
       9879, 9884, 6708, 6713, 450,  453,  9268, 9277,  8675, 8680, 7675, 7678,
       8966, 8976, 2730, 2732, 1324, 1330, 3418, 3424,  3576, 3584, 9334, 9335,
       8714, 8717, 2863, 2869, 7255, 7261, 1525, 1531,  8600, 8605, 2374, 2384,
       4523, 4524, 8766, 8769, 406,  411,  6983, 6989,  3555, 3556, 5634, 5642,
       8276, 8278, 504,  508,  3651, 3654, 9842, 9849,  3392, 3398, 313,  317,
       1848, 1854, 4034, 4039, 6014, 6024, 9228, 9232,  819,  823,  8419, 8425,
       1400, 1403, 4653, 4659, 8360, 8364, 6942, 6945,  4130, 4139, 460,  466,
       5664, 5665, 5288, 5297, 2472, 2480, 5450, 5456,  7018, 7023, 6052, 6061,
       7206, 7216, 3937, 3944, 6032, 6034, 725,  731,   944,  947,  2756, 2766,
       7437, 7438, 4135, 4141, 153,  157,  6124, 6125,  8390, 8391, 4521, 4530,
       8656, 8664, 7553, 7554, 4234, 4239, 8518, 8526});

  llvm::SmallVector<MultidimensionalRange> insertedRanges;

  for (size_t i = 0; i < insertedRangesBoundaries.size(); i += 2) {
    MultidimensionalRange object(
        Range(insertedRangesBoundaries[i], insertedRangesBoundaries[i + 1]));
    indices += object;
    insertedRanges.push_back(object);
  }

  llvm::SmallVector<int64_t> removedRangesBoundaries(
      {2807, 2904, 1848, 1858, 1332, 1384, 8650, 8673, 1355, 1368, 2598, 2620,
       5932, 5985, 9228, 9282, 3962, 3978, 3351, 3419, 9959, 9997, 5634, 5682,
       3696, 3782, 5705, 5775, 3637, 3719, 406,  481,  8823, 8840, 2756, 2825,
       9653, 9732, 1848, 1924, 2884, 2960, 1178, 1220, 5344, 5366, 1400, 1453,
       9004, 9068, 4596, 4666, 7197, 7276, 3327, 3359, 4760, 4831, 6942, 7025,
       402,  434,  8041, 8065, 7295, 7383, 3996, 4080, 6348, 6377, 4541, 4638,
       471,  481,  3426, 3438, 821,  857,  270,  271,  3623, 3690, 1688, 1784,
       1361, 1457, 7857, 7949, 8700, 8719, 1705, 1793, 140,  141,  3622, 3672,
       8613, 8648, 3526, 3626, 6242, 6268, 7328, 7387, 5754, 5845, 8877, 8968,
       8518, 8546, 1036, 1076, 8463, 8492, 9663, 9668, 8602, 8692, 2829, 2896,
       6546, 6629, 651,  707,  9116, 9155, 1327, 1380, 6335, 6434, 7564, 7652,
       5864, 5927, 5558, 5642, 6737, 6749, 6420, 6451, 2778, 2818, 8605, 8686,
       1004, 1030, 391,  441,  7940, 8005, 8778, 8871, 2549, 2591, 6156, 6162,
       1990, 2010, 8835, 8903, 9820, 9832, 6879, 6960, 6605, 6630, 7890, 7900,
       896,  922,  1231, 1247, 7927, 7981, 422,  487,  927,  968,  4040, 4069,
       2508, 2553, 4500, 4587, 1538, 1595, 1173, 1209, 5729, 5785, 1207, 1218});

  llvm::SmallVector<MultidimensionalRange> removedRanges;

  for (size_t i = 0; i < removedRangesBoundaries.size(); i += 2) {
    MultidimensionalRange object(
        Range(removedRangesBoundaries[i], removedRangesBoundaries[i + 1]));

    indices -= object;
    removedRanges.push_back(object);
  }

  llvm::DenseSet<Point> expectedPoints;

  for (const MultidimensionalRange &range : insertedRanges) {
    for (Point point : range) {
      expectedPoints.insert(point);
    }
  }

  for (const MultidimensionalRange &range : removedRanges) {
    for (Point point : range) {
      expectedPoints.erase(point);
    }
  }

  llvm::SmallVector<Point> actualPoints(indices.begin(), indices.end());
  EXPECT_THAT(actualPoints, testing::UnorderedElementsAreArray(expectedPoints));
}
